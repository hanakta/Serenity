<?php
// üì§ –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –∏–∑ SQLite –≤ JSON –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ –≤ PHPMyAdmin

require_once 'vendor/autoload.php';

echo "=== –≠–ö–°–ü–û–†–¢ –î–ê–ù–ù–´–• –í JSON –î–õ–Ø PHPMyAdmin ===\n\n";

try {
    // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ SQLite
    $sqliteConfig = require 'config/database.php';
    $sqliteDb = new PDO(
        "sqlite:" . $sqliteConfig['database'],
        null,
        null,
        $sqliteConfig['options']
    );
    
    echo "‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ SQLite —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ\n";
    
    // –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞
    if (!is_dir('export')) {
        mkdir('export', 0755, true);
    }
    
    // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    echo "üë• –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...\n";
    $users = $sqliteDb->query("SELECT * FROM users")->fetchAll();
    file_put_contents('export/users.json', json_encode($users, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE));
    echo "‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã: " . count($users) . " –∑–∞–ø–∏—Å–µ–π\n";
    
    // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∫–æ–º–∞–Ω–¥—ã
    echo "üë• –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∫–æ–º–∞–Ω–¥—ã...\n";
    $teams = $sqliteDb->query("SELECT * FROM teams")->fetchAll();
    file_put_contents('export/teams.json', json_encode($teams, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE));
    echo "‚úÖ –ö–æ–º–∞–Ω–¥—ã —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã: " . count($teams) . " –∑–∞–ø–∏—Å–µ–π\n";
    
    // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∫–æ–º–∞–Ω–¥
    echo "üë• –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∫–æ–º–∞–Ω–¥...\n";
    $members = $sqliteDb->query("SELECT * FROM team_members")->fetchAll();
    file_put_contents('export/team_members.json', json_encode($members, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE));
    echo "‚úÖ –£—á–∞—Å—Ç–Ω–∏–∫–∏ –∫–æ–º–∞–Ω–¥ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã: " . count($members) . " –∑–∞–ø–∏—Å–µ–π\n";
    
    // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∑–∞–¥–∞—á–∏
    echo "üìã –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∑–∞–¥–∞—á–∏...\n";
    $tasks = $sqliteDb->query("SELECT * FROM tasks")->fetchAll();
    file_put_contents('export/tasks.json', json_encode($tasks, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE));
    echo "‚úÖ –ó–∞–¥–∞—á–∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã: " . count($tasks) . " –∑–∞–ø–∏—Å–µ–π\n";
    
    // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –ø—Ä–æ–µ–∫—Ç—ã
    echo "üìÅ –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –ø—Ä–æ–µ–∫—Ç—ã...\n";
    $projects = $sqliteDb->query("SELECT * FROM projects")->fetchAll();
    file_put_contents('export/projects.json', json_encode($projects, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE));
    echo "‚úÖ –ü—Ä–æ–µ–∫—Ç—ã —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã: " . count($projects) . " –∑–∞–ø–∏—Å–µ–π\n";
    
    // –°–æ–∑–¥–∞–µ–º SQL —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ –≤ MySQL
    echo "üìù –°–æ–∑–¥–∞–µ–º SQL —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞...\n";
    
    $sqlScript = "-- SQL —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ –≤ MySQL/PHPMyAdmin\n";
    $sqlScript .= "-- –°–æ–∑–¥–∞–π—Ç–µ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö: CREATE DATABASE serenity_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;\n";
    $sqlScript .= "-- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö: USE serenity_db;\n\n";
    
    // –î–æ–±–∞–≤–ª—è–µ–º CREATE TABLE statements
    $sqlScript .= "-- –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü\n";
    $sqlScript .= "CREATE TABLE IF NOT EXISTS users (\n";
    $sqlScript .= "    id VARCHAR(36) PRIMARY KEY,\n";
    $sqlScript .= "    name VARCHAR(255) NOT NULL,\n";
    $sqlScript .= "    email VARCHAR(255) UNIQUE NOT NULL,\n";
    $sqlScript .= "    password_hash VARCHAR(255) NOT NULL,\n";
    $sqlScript .= "    avatar VARCHAR(255),\n";
    $sqlScript .= "    role ENUM('user', 'admin') DEFAULT 'user',\n";
    $sqlScript .= "    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n";
    $sqlScript .= "    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP\n";
    $sqlScript .= ") ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n\n";
    
    $sqlScript .= "CREATE TABLE IF NOT EXISTS teams (\n";
    $sqlScript .= "    id VARCHAR(36) PRIMARY KEY,\n";
    $sqlScript .= "    name VARCHAR(255) NOT NULL,\n";
    $sqlScript .= "    description TEXT,\n";
    $sqlScript .= "    color VARCHAR(7) DEFAULT '#3B82F6',\n";
    $sqlScript .= "    owner_id VARCHAR(36) NOT NULL,\n";
    $sqlScript .= "    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n";
    $sqlScript .= "    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n";
    $sqlScript .= "    FOREIGN KEY (owner_id) REFERENCES users(id) ON DELETE CASCADE\n";
    $sqlScript .= ") ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n\n";
    
    $sqlScript .= "CREATE TABLE IF NOT EXISTS team_members (\n";
    $sqlScript .= "    id VARCHAR(36) PRIMARY KEY,\n";
    $sqlScript .= "    team_id VARCHAR(36) NOT NULL,\n";
    $sqlScript .= "    user_id VARCHAR(36) NOT NULL,\n";
    $sqlScript .= "    role ENUM('admin', 'member', 'viewer') DEFAULT 'member',\n";
    $sqlScript .= "    joined_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n";
    $sqlScript .= "    FOREIGN KEY (team_id) REFERENCES teams(id) ON DELETE CASCADE,\n";
    $sqlScript .= "    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,\n";
    $sqlScript .= "    UNIQUE KEY unique_team_user (team_id, user_id)\n";
    $sqlScript .= ") ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n\n";
    
    $sqlScript .= "CREATE TABLE IF NOT EXISTS tasks (\n";
    $sqlScript .= "    id VARCHAR(36) PRIMARY KEY,\n";
    $sqlScript .= "    title VARCHAR(255) NOT NULL,\n";
    $sqlScript .= "    description TEXT,\n";
    $sqlScript .= "    status ENUM('todo', 'in_progress', 'done') DEFAULT 'todo',\n";
    $sqlScript .= "    priority ENUM('low', 'medium', 'high') DEFAULT 'medium',\n";
    $sqlScript .= "    user_id VARCHAR(36) NOT NULL,\n";
    $sqlScript .= "    team_id VARCHAR(36),\n";
    $sqlScript .= "    due_date TIMESTAMP NULL,\n";
    $sqlScript .= "    completed_at TIMESTAMP NULL,\n";
    $sqlScript .= "    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n";
    $sqlScript .= "    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n";
    $sqlScript .= "    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,\n";
    $sqlScript .= "    FOREIGN KEY (team_id) REFERENCES teams(id) ON DELETE SET NULL\n";
    $sqlScript .= ") ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n\n";
    
    $sqlScript .= "CREATE TABLE IF NOT EXISTS projects (\n";
    $sqlScript .= "    id VARCHAR(36) PRIMARY KEY,\n";
    $sqlScript .= "    name VARCHAR(255) NOT NULL,\n";
    $sqlScript .= "    description TEXT,\n";
    $sqlScript .= "    user_id VARCHAR(36) NOT NULL,\n";
    $sqlScript .= "    team_id VARCHAR(36),\n";
    $sqlScript .= "    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,\n";
    $sqlScript .= "    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,\n";
    $sqlScript .= "    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,\n";
    $sqlScript .= "    FOREIGN KEY (team_id) REFERENCES teams(id) ON DELETE SET NULL\n";
    $sqlScript .= ") ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;\n\n";
    
    // –î–æ–±–∞–≤–ª—è–µ–º INSERT statements –¥–ª—è –¥–∞–Ω–Ω—ã—Ö
    $sqlScript .= "-- –í—Å—Ç–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö\n";
    
    foreach ($users as $user) {
        $sqlScript .= "INSERT INTO users (id, name, email, password_hash, avatar, role, created_at, updated_at) VALUES ";
        $sqlScript .= "('" . addslashes($user['id']) . "', ";
        $sqlScript .= "'" . addslashes($user['name']) . "', ";
        $sqlScript .= "'" . addslashes($user['email']) . "', ";
        $sqlScript .= "'" . addslashes($user['password_hash']) . "', ";
        $sqlScript .= ($user['avatar'] ? "'" . addslashes($user['avatar']) . "'" : 'NULL') . ", ";
        $sqlScript .= "'" . addslashes($user['role'] ?? 'user') . "', ";
        $sqlScript .= "'" . addslashes($user['created_at']) . "', ";
        $sqlScript .= "'" . addslashes($user['updated_at']) . "');\n";
    }
    
    foreach ($teams as $team) {
        $sqlScript .= "INSERT INTO teams (id, name, description, color, owner_id, created_at, updated_at) VALUES ";
        $sqlScript .= "('" . addslashes($team['id']) . "', ";
        $sqlScript .= "'" . addslashes($team['name']) . "', ";
        $sqlScript .= ($team['description'] ? "'" . addslashes($team['description']) . "'" : 'NULL') . ", ";
        $sqlScript .= "'" . addslashes($team['color'] ?? '#3B82F6') . "', ";
        $sqlScript .= "'" . addslashes($team['owner_id']) . "', ";
        $sqlScript .= "'" . addslashes($team['created_at']) . "', ";
        $sqlScript .= "'" . addslashes($team['updated_at']) . "');\n";
    }
    
    foreach ($members as $member) {
        $sqlScript .= "INSERT INTO team_members (id, team_id, user_id, role, joined_at) VALUES ";
        $sqlScript .= "('" . addslashes($member['id']) . "', ";
        $sqlScript .= "'" . addslashes($member['team_id']) . "', ";
        $sqlScript .= "'" . addslashes($member['user_id']) . "', ";
        $sqlScript .= "'" . addslashes($member['role'] ?? 'member') . "', ";
        $sqlScript .= "'" . addslashes($member['joined_at']) . "');\n";
    }
    
    foreach ($tasks as $task) {
        $sqlScript .= "INSERT INTO tasks (id, title, description, status, priority, user_id, team_id, due_date, completed_at, created_at, updated_at) VALUES ";
        $sqlScript .= "('" . addslashes($task['id']) . "', ";
        $sqlScript .= "'" . addslashes($task['title']) . "', ";
        $sqlScript .= ($task['description'] ? "'" . addslashes($task['description']) . "'" : 'NULL') . ", ";
        $sqlScript .= "'" . addslashes($task['status'] ?? 'todo') . "', ";
        $sqlScript .= "'" . addslashes($task['priority'] ?? 'medium') . "', ";
        $sqlScript .= "'" . addslashes($task['user_id']) . "', ";
        $sqlScript .= ($task['team_id'] ? "'" . addslashes($task['team_id']) . "'" : 'NULL') . ", ";
        $sqlScript .= ($task['due_date'] ? "'" . addslashes($task['due_date']) . "'" : 'NULL') . ", ";
        $sqlScript .= ($task['completed_at'] ? "'" . addslashes($task['completed_at']) . "'" : 'NULL') . ", ";
        $sqlScript .= "'" . addslashes($task['created_at']) . "', ";
        $sqlScript .= "'" . addslashes($task['updated_at']) . "');\n";
    }
    
    foreach ($projects as $project) {
        $sqlScript .= "INSERT INTO projects (id, name, description, user_id, team_id, created_at, updated_at) VALUES ";
        $sqlScript .= "('" . addslashes($project['id']) . "', ";
        $sqlScript .= "'" . addslashes($project['name']) . "', ";
        $sqlScript .= ($project['description'] ? "'" . addslashes($project['description']) . "'" : 'NULL') . ", ";
        $sqlScript .= "'" . addslashes($project['user_id']) . "', ";
        $sqlScript .= ($project['team_id'] ? "'" . addslashes($project['team_id']) . "'" : 'NULL') . ", ";
        $sqlScript .= "'" . addslashes($project['created_at']) . "', ";
        $sqlScript .= "'" . addslashes($project['updated_at']) . "');\n";
    }
    
    file_put_contents('export/import_to_mysql.sql', $sqlScript);
    echo "‚úÖ SQL —Å–∫—Ä–∏–ø—Ç —Å–æ–∑–¥–∞–Ω\n\n";
    
    // –°–æ–∑–¥–∞–µ–º README —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏
    $readme = "# üì§ –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è PHPMyAdmin\n\n";
    $readme .= "## üìÅ –§–∞–π–ª—ã —ç–∫—Å–ø–æ—Ä—Ç–∞:\n";
    $readme .= "- `users.json` - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (" . count($users) . " –∑–∞–ø–∏—Å–µ–π)\n";
    $readme .= "- `teams.json` - –∫–æ–º–∞–Ω–¥—ã (" . count($teams) . " –∑–∞–ø–∏—Å–µ–π)\n";
    $readme .= "- `team_members.json` - —É—á–∞—Å—Ç–Ω–∏–∫–∏ –∫–æ–º–∞–Ω–¥ (" . count($members) . " –∑–∞–ø–∏—Å–µ–π)\n";
    $readme .= "- `tasks.json` - –∑–∞–¥–∞—á–∏ (" . count($tasks) . " –∑–∞–ø–∏—Å–µ–π)\n";
    $readme .= "- `projects.json` - –ø—Ä–æ–µ–∫—Ç—ã (" . count($projects) . " –∑–∞–ø–∏—Å–µ–π)\n";
    $readme .= "- `import_to_mysql.sql` - SQL —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞\n\n";
    $readme .= "## üöÄ –ö–∞–∫ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤ PHPMyAdmin:\n\n";
    $readme .= "1. **–û—Ç–∫—Ä–æ–π—Ç–µ PHPMyAdmin** (http://localhost/phpmyadmin)\n";
    $readme .= "2. **–°–æ–∑–¥–∞–π—Ç–µ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö** `serenity_db`\n";
    $readme .= "3. **–í—ã–±–µ—Ä–∏—Ç–µ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö** `serenity_db`\n";
    $readme .= "4. **–ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É** \"SQL\"\n";
    $readme .= "5. **–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ –≤—Å—Ç–∞–≤—å—Ç–µ** —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ `import_to_mysql.sql`\n";
    $readme .= "6. **–ù–∞–∂–º–∏—Ç–µ** \"–í—ã–ø–æ–ª–Ω–∏—Ç—å\"\n\n";
    $readme .= "## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–∞–Ω–Ω—ã—Ö:\n";
    $readme .= "- üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏: " . count($users) . "\n";
    $readme .= "- üë• –ö–æ–º–∞–Ω–¥—ã: " . count($teams) . "\n";
    $readme .= "- üë• –£—á–∞—Å—Ç–Ω–∏–∫–∏: " . count($members) . "\n";
    $readme .= "- üìã –ó–∞–¥–∞—á–∏: " . count($tasks) . "\n";
    $readme .= "- üìÅ –ü—Ä–æ–µ–∫—Ç—ã: " . count($projects) . "\n\n";
    $readme .= "## üîÑ –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–±:\n";
    $readme .= "–í—ã —Ç–∞–∫–∂–µ –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å JSON —Ñ–∞–π–ª—ã –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞ —á–µ—Ä–µ–∑ PHP —Å–∫—Ä–∏–ø—Ç –∏–ª–∏ –¥—Ä—É–≥–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã.\n";
    
    file_put_contents('export/README.md', $readme);
    echo "‚úÖ README —Å–æ–∑–¥–∞–Ω\n\n";
    
    echo "üéâ –≠–ö–°–ü–û–†–¢ –ó–ê–í–ï–†–®–ï–ù –£–°–ü–ï–®–ù–û!\n\n";
    echo "üìÅ –§–∞–π–ª—ã —Å–æ–∑–¥–∞–Ω—ã –≤ –ø–∞–ø–∫–µ: export/\n";
    echo "   üìÑ users.json\n";
    echo "   üìÑ teams.json\n";
    echo "   üìÑ team_members.json\n";
    echo "   üìÑ tasks.json\n";
    echo "   üìÑ projects.json\n";
    echo "   üìÑ import_to_mysql.sql\n";
    echo "   üìÑ README.md\n\n";
    
    echo "üîó –î–ª—è –∏–º–ø–æ—Ä—Ç–∞ –≤ PHPMyAdmin:\n";
    echo "   1. –û—Ç–∫—Ä–æ–π—Ç–µ http://localhost/phpmyadmin\n";
    echo "   2. –°–æ–∑–¥–∞–π—Ç–µ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö 'serenity_db'\n";
    echo "   3. –í—ã–±–µ—Ä–∏—Ç–µ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö\n";
    echo "   4. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É 'SQL'\n";
    echo "   5. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞ 'import_to_mysql.sql'\n";
    echo "   6. –ù–∞–∂–º–∏—Ç–µ '–í—ã–ø–æ–ª–Ω–∏—Ç—å'\n";
    
} catch (Exception $e) {
    echo "‚ùå –û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: " . $e->getMessage() . "\n";
    echo "–°—Ç–µ–∫ –≤—ã–∑–æ–≤–æ–≤:\n" . $e->getTraceAsString() . "\n";
}

