<?php
// üöÄ –ú–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ localStorage –≤ MySQL

require_once 'vendor/autoload.php';

// –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
$dotenv = Dotenv\Dotenv::createImmutable(__DIR__);
$dotenv->load();

use App\Database\Database;

echo "=== –ú–ò–ì–†–ê–¶–ò–Ø –î–ê–ù–ù–´–• –í MYSQL ===\n\n";

try {
    // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ SQLite (–∏—Å—Ç–æ—á–Ω–∏–∫)
    $sqliteConfig = require 'config/database.php';
    $sqliteDb = new PDO(
        "sqlite:" . $sqliteConfig['database'],
        null,
        null,
        $sqliteConfig['options']
    );
    
    echo "‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ SQLite —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ\n";
    
    // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ MySQL (–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ)
    $mysqlConfig = require 'config/database_mysql.php';
    $mysqlDb = new PDO(
        "mysql:host={$mysqlConfig['host']};port={$mysqlConfig['port']};dbname={$mysqlConfig['database']};charset={$mysqlConfig['charset']}",
        $mysqlConfig['username'],
        $mysqlConfig['password'],
        $mysqlConfig['options']
    );
    
    echo "‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ MySQL —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ\n\n";
    
    // –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—ã –≤ MySQL
    echo "üìã –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—ã –≤ MySQL...\n";
    
    $createTablesSQL = "
    CREATE TABLE IF NOT EXISTS users (
        id VARCHAR(36) PRIMARY KEY,
        name VARCHAR(255) NOT NULL,
        email VARCHAR(255) UNIQUE NOT NULL,
        password_hash VARCHAR(255) NOT NULL,
        avatar VARCHAR(255),
        role ENUM('user', 'admin') DEFAULT 'user',
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
    );
    
    CREATE TABLE IF NOT EXISTS teams (
        id VARCHAR(36) PRIMARY KEY,
        name VARCHAR(255) NOT NULL,
        description TEXT,
        color VARCHAR(7) DEFAULT '#3B82F6',
        owner_id VARCHAR(36) NOT NULL,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
        FOREIGN KEY (owner_id) REFERENCES users(id) ON DELETE CASCADE
    );
    
    CREATE TABLE IF NOT EXISTS team_members (
        id VARCHAR(36) PRIMARY KEY,
        team_id VARCHAR(36) NOT NULL,
        user_id VARCHAR(36) NOT NULL,
        role ENUM('admin', 'member', 'viewer') DEFAULT 'member',
        joined_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (team_id) REFERENCES teams(id) ON DELETE CASCADE,
        FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
        UNIQUE KEY unique_team_user (team_id, user_id)
    );
    
    CREATE TABLE IF NOT EXISTS team_invitations (
        id VARCHAR(36) PRIMARY KEY,
        team_id VARCHAR(36) NOT NULL,
        email VARCHAR(255) NOT NULL,
        role ENUM('admin', 'member', 'viewer') DEFAULT 'member',
        status ENUM('pending', 'accepted', 'declined') DEFAULT 'pending',
        invited_by VARCHAR(36) NOT NULL,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (team_id) REFERENCES teams(id) ON DELETE CASCADE,
        FOREIGN KEY (invited_by) REFERENCES users(id) ON DELETE CASCADE
    );
    
    CREATE TABLE IF NOT EXISTS tasks (
        id VARCHAR(36) PRIMARY KEY,
        title VARCHAR(255) NOT NULL,
        description TEXT,
        status ENUM('todo', 'in_progress', 'done') DEFAULT 'todo',
        priority ENUM('low', 'medium', 'high') DEFAULT 'medium',
        user_id VARCHAR(36) NOT NULL,
        team_id VARCHAR(36),
        due_date TIMESTAMP NULL,
        completed_at TIMESTAMP NULL,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
        FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
        FOREIGN KEY (team_id) REFERENCES teams(id) ON DELETE SET NULL
    );
    
    CREATE TABLE IF NOT EXISTS task_comments (
        id VARCHAR(36) PRIMARY KEY,
        task_id VARCHAR(36) NOT NULL,
        user_id VARCHAR(36) NOT NULL,
        content TEXT NOT NULL,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (task_id) REFERENCES tasks(id) ON DELETE CASCADE,
        FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
    );
    
    CREATE TABLE IF NOT EXISTS projects (
        id VARCHAR(36) PRIMARY KEY,
        name VARCHAR(255) NOT NULL,
        description TEXT,
        user_id VARCHAR(36) NOT NULL,
        team_id VARCHAR(36),
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
        FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
        FOREIGN KEY (team_id) REFERENCES teams(id) ON DELETE SET NULL
    );
    
    CREATE TABLE IF NOT EXISTS notifications (
        id VARCHAR(36) PRIMARY KEY,
        user_id VARCHAR(36) NOT NULL,
        title VARCHAR(255) NOT NULL,
        message TEXT NOT NULL,
        type VARCHAR(50) NOT NULL,
        is_read BOOLEAN DEFAULT FALSE,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
    );
    
    CREATE TABLE IF NOT EXISTS activity_logs (
        id VARCHAR(36) PRIMARY KEY,
        user_id VARCHAR(36) NOT NULL,
        team_id VARCHAR(36),
        action VARCHAR(100) NOT NULL,
        description TEXT,
        metadata JSON,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
        FOREIGN KEY (team_id) REFERENCES teams(id) ON DELETE SET NULL
    );
    ";
    
    $mysqlDb->exec($createTablesSQL);
    echo "‚úÖ –¢–∞–±–ª–∏—Ü—ã —Å–æ–∑–¥–∞–Ω—ã\n\n";
    
    // –ú–∏–≥—Ä–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    echo "üë• –ú–∏–≥—Ä–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...\n";
    $users = $sqliteDb->query("SELECT * FROM users")->fetchAll();
    foreach ($users as $user) {
        $stmt = $mysqlDb->prepare("
            INSERT INTO users (id, name, email, password_hash, avatar, role, created_at, updated_at) 
            VALUES (?, ?, ?, ?, ?, ?, ?, ?)
            ON DUPLICATE KEY UPDATE 
            name = VALUES(name), 
            email = VALUES(email), 
            password_hash = VALUES(password_hash),
            avatar = VALUES(avatar),
            role = VALUES(role),
            updated_at = VALUES(updated_at)
        ");
        $stmt->execute([
            $user['id'],
            $user['name'],
            $user['email'],
            $user['password_hash'],
            $user['avatar'] ?? null,
            $user['role'] ?? 'user',
            $user['created_at'],
            $user['updated_at']
        ]);
    }
    echo "‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã: " . count($users) . " –∑–∞–ø–∏—Å–µ–π\n";
    
    // –ú–∏–≥—Ä–∏—Ä—É–µ–º –∫–æ–º–∞–Ω–¥—ã
    echo "üë• –ú–∏–≥—Ä–∏—Ä—É–µ–º –∫–æ–º–∞–Ω–¥—ã...\n";
    $teams = $sqliteDb->query("SELECT * FROM teams")->fetchAll();
    foreach ($teams as $team) {
        $stmt = $mysqlDb->prepare("
            INSERT INTO teams (id, name, description, color, owner_id, created_at, updated_at) 
            VALUES (?, ?, ?, ?, ?, ?, ?)
            ON DUPLICATE KEY UPDATE 
            name = VALUES(name), 
            description = VALUES(description), 
            color = VALUES(color),
            owner_id = VALUES(owner_id),
            updated_at = VALUES(updated_at)
        ");
        $stmt->execute([
            $team['id'],
            $team['name'],
            $team['description'] ?? null,
            $team['color'] ?? '#3B82F6',
            $team['owner_id'],
            $team['created_at'],
            $team['updated_at']
        ]);
    }
    echo "‚úÖ –ö–æ–º–∞–Ω–¥—ã –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã: " . count($teams) . " –∑–∞–ø–∏—Å–µ–π\n";
    
    // –ú–∏–≥—Ä–∏—Ä—É–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∫–æ–º–∞–Ω–¥
    echo "üë• –ú–∏–≥—Ä–∏—Ä—É–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∫–æ–º–∞–Ω–¥...\n";
    $members = $sqliteDb->query("SELECT * FROM team_members")->fetchAll();
    foreach ($members as $member) {
        $stmt = $mysqlDb->prepare("
            INSERT INTO team_members (id, team_id, user_id, role, joined_at) 
            VALUES (?, ?, ?, ?, ?)
            ON DUPLICATE KEY UPDATE 
            role = VALUES(role)
        ");
        $stmt->execute([
            $member['id'],
            $member['team_id'],
            $member['user_id'],
            $member['role'] ?? 'member',
            $member['joined_at']
        ]);
    }
    echo "‚úÖ –£—á–∞—Å—Ç–Ω–∏–∫–∏ –∫–æ–º–∞–Ω–¥ –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã: " . count($members) . " –∑–∞–ø–∏—Å–µ–π\n";
    
    // –ú–∏–≥—Ä–∏—Ä—É–µ–º –∑–∞–¥–∞—á–∏
    echo "üìã –ú–∏–≥—Ä–∏—Ä—É–µ–º –∑–∞–¥–∞—á–∏...\n";
    $tasks = $sqliteDb->query("SELECT * FROM tasks")->fetchAll();
    foreach ($tasks as $task) {
        $stmt = $mysqlDb->prepare("
            INSERT INTO tasks (id, title, description, status, priority, user_id, team_id, due_date, completed_at, created_at, updated_at) 
            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
            ON DUPLICATE KEY UPDATE 
            title = VALUES(title), 
            description = VALUES(description), 
            status = VALUES(status),
            priority = VALUES(priority),
            due_date = VALUES(due_date),
            completed_at = VALUES(completed_at),
            updated_at = VALUES(updated_at)
        ");
        $stmt->execute([
            $task['id'],
            $task['title'],
            $task['description'] ?? null,
            $task['status'] ?? 'todo',
            $task['priority'] ?? 'medium',
            $task['user_id'],
            $task['team_id'] ?? null,
            $task['due_date'] ?? null,
            $task['completed_at'] ?? null,
            $task['created_at'],
            $task['updated_at']
        ]);
    }
    echo "‚úÖ –ó–∞–¥–∞—á–∏ –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã: " . count($tasks) . " –∑–∞–ø–∏—Å–µ–π\n";
    
    // –ú–∏–≥—Ä–∏—Ä—É–µ–º –ø—Ä–æ–µ–∫—Ç—ã
    echo "üìÅ –ú–∏–≥—Ä–∏—Ä—É–µ–º –ø—Ä–æ–µ–∫—Ç—ã...\n";
    $projects = $sqliteDb->query("SELECT * FROM projects")->fetchAll();
    foreach ($projects as $project) {
        $stmt = $mysqlDb->prepare("
            INSERT INTO projects (id, name, description, user_id, team_id, created_at, updated_at) 
            VALUES (?, ?, ?, ?, ?, ?, ?)
            ON DUPLICATE KEY UPDATE 
            name = VALUES(name), 
            description = VALUES(description), 
            team_id = VALUES(team_id),
            updated_at = VALUES(updated_at)
        ");
        $stmt->execute([
            $project['id'],
            $project['name'],
            $project['description'] ?? null,
            $project['user_id'],
            $project['team_id'] ?? null,
            $project['created_at'],
            $project['updated_at']
        ]);
    }
    echo "‚úÖ –ü—Ä–æ–µ–∫—Ç—ã –º–∏–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã: " . count($projects) . " –∑–∞–ø–∏—Å–µ–π\n";
    
    echo "\nüéâ –ú–ò–ì–†–ê–¶–ò–Ø –ó–ê–í–ï–†–®–ï–ù–ê –£–°–ü–ï–®–ù–û!\n";
    echo "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:\n";
    echo "   üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏: " . count($users) . "\n";
    echo "   üë• –ö–æ–º–∞–Ω–¥—ã: " . count($teams) . "\n";
    echo "   üë• –£—á–∞—Å—Ç–Ω–∏–∫–∏: " . count($members) . "\n";
    echo "   üìã –ó–∞–¥–∞—á–∏: " . count($tasks) . "\n";
    echo "   üìÅ –ü—Ä–æ–µ–∫—Ç—ã: " . count($projects) . "\n";
    
    echo "\nüîó –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ PHPMyAdmin:\n";
    echo "   URL: http://localhost/phpmyadmin\n";
    echo "   –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: serenity_db\n";
    echo "   –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: root\n";
    echo "   –ü–∞—Ä–æ–ª—å: (–ø—É—Å—Ç–æ–π)\n";
    
} catch (Exception $e) {
    echo "‚ùå –û—à–∏–±–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏: " . $e->getMessage() . "\n";
    echo "–°—Ç–µ–∫ –≤—ã–∑–æ–≤–æ–≤:\n" . $e->getTraceAsString() . "\n";
}

