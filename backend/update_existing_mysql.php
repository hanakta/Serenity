<?php
// üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö serenity –≤ PHPMyAdmin

require_once 'vendor/autoload.php';

echo "=== –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–£–©–ï–°–¢–í–£–Æ–©–ï–ô –ë–ê–ó–´ –î–ê–ù–ù–´–• SERENITY ===\n\n";

try {
    // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö serenity
    $mysqlDb = new PDO(
        "mysql:host=localhost;port=8889;dbname=serenity;charset=utf8mb4",
        'root',
        'root',
        [
            PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
            PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
            PDO::ATTR_EMULATE_PREPARES => false,
        ]
    );
    
    echo "‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –±–∞–∑–µ 'serenity' —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ\n";
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–∞–±–ª–∏—Ü—ã
    echo "üìã –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–∞–±–ª–∏—Ü—ã...\n";
    $existingTables = $mysqlDb->query("SHOW TABLES")->fetchAll(PDO::FETCH_COLUMN);
    echo "–ù–∞–π–¥–µ–Ω–æ —Ç–∞–±–ª–∏—Ü: " . count($existingTables) . "\n";
    foreach ($existingTables as $table) {
        echo "  - $table\n";
    }
    echo "\n";
    
    // –°–æ–∑–¥–∞–µ–º –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –∫–æ–º–∞–Ω–¥
    echo "üë• –°–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—ã –¥–ª—è –∫–æ–º–∞–Ω–¥...\n";
    
    $createTeamsTable = "
    CREATE TABLE IF NOT EXISTS teams (
        id VARCHAR(36) PRIMARY KEY,
        name VARCHAR(255) NOT NULL,
        description TEXT,
        color VARCHAR(7) DEFAULT '#3B82F6',
        owner_id VARCHAR(36) NOT NULL,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
        FOREIGN KEY (owner_id) REFERENCES users(id) ON DELETE CASCADE
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
    ";
    
    $createTeamMembersTable = "
    CREATE TABLE IF NOT EXISTS team_members (
        id VARCHAR(36) PRIMARY KEY,
        team_id VARCHAR(36) NOT NULL,
        user_id VARCHAR(36) NOT NULL,
        role ENUM('admin', 'member', 'viewer') DEFAULT 'member',
        joined_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (team_id) REFERENCES teams(id) ON DELETE CASCADE,
        FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
        UNIQUE KEY unique_team_user (team_id, user_id)
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
    ";
    
    $createTeamInvitationsTable = "
    CREATE TABLE IF NOT EXISTS team_invitations (
        id VARCHAR(36) PRIMARY KEY,
        team_id VARCHAR(36) NOT NULL,
        email VARCHAR(255) NOT NULL,
        role ENUM('admin', 'member', 'viewer') DEFAULT 'member',
        status ENUM('pending', 'accepted', 'declined') DEFAULT 'pending',
        invited_by VARCHAR(36) NOT NULL,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (team_id) REFERENCES teams(id) ON DELETE CASCADE,
        FOREIGN KEY (invited_by) REFERENCES users(id) ON DELETE CASCADE
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
    ";
    
    $createTaskCommentsTable = "
    CREATE TABLE IF NOT EXISTS task_comments (
        id VARCHAR(36) PRIMARY KEY,
        task_id VARCHAR(36) NOT NULL,
        user_id VARCHAR(36) NOT NULL,
        content TEXT NOT NULL,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (task_id) REFERENCES tasks(id) ON DELETE CASCADE,
        FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
    ";
    
    $createActivityLogsTable = "
    CREATE TABLE IF NOT EXISTS activity_logs (
        id VARCHAR(36) PRIMARY KEY,
        user_id VARCHAR(36) NOT NULL,
        team_id VARCHAR(36),
        action VARCHAR(100) NOT NULL,
        description TEXT,
        metadata JSON,
        created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
        FOREIGN KEY (team_id) REFERENCES teams(id) ON DELETE SET NULL
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
    ";
    
    // –í—ã–ø–æ–ª–Ω—è–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü
    $mysqlDb->exec($createTeamsTable);
    echo "‚úÖ –¢–∞–±–ª–∏—Ü–∞ 'teams' —Å–æ–∑–¥–∞–Ω–∞/–æ–±–Ω–æ–≤–ª–µ–Ω–∞\n";
    
    $mysqlDb->exec($createTeamMembersTable);
    echo "‚úÖ –¢–∞–±–ª–∏—Ü–∞ 'team_members' —Å–æ–∑–¥–∞–Ω–∞/–æ–±–Ω–æ–≤–ª–µ–Ω–∞\n";
    
    $mysqlDb->exec($createTeamInvitationsTable);
    echo "‚úÖ –¢–∞–±–ª–∏—Ü–∞ 'team_invitations' —Å–æ–∑–¥–∞–Ω–∞/–æ–±–Ω–æ–≤–ª–µ–Ω–∞\n";
    
    $mysqlDb->exec($createTaskCommentsTable);
    echo "‚úÖ –¢–∞–±–ª–∏—Ü–∞ 'task_comments' —Å–æ–∑–¥–∞–Ω–∞/–æ–±–Ω–æ–≤–ª–µ–Ω–∞\n";
    
    $mysqlDb->exec($createActivityLogsTable);
    echo "‚úÖ –¢–∞–±–ª–∏—Ü–∞ 'activity_logs' —Å–æ–∑–¥–∞–Ω–∞/–æ–±–Ω–æ–≤–ª–µ–Ω–∞\n";
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–ª–æ–Ω–∫—É team_id –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Ç–∞–±–ª–∏—Ü–µ tasks, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
    echo "\nüîß –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ç–∞–±–ª–∏—Ü—É 'tasks'...\n";
    try {
        $mysqlDb->exec("ALTER TABLE tasks ADD COLUMN team_id VARCHAR(36) NULL");
        $mysqlDb->exec("ALTER TABLE tasks ADD FOREIGN KEY (team_id) REFERENCES teams(id) ON DELETE SET NULL");
        echo "‚úÖ –ö–æ–ª–æ–Ω–∫–∞ 'team_id' –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∫ —Ç–∞–±–ª–∏—Ü–µ 'tasks'\n";
    } catch (Exception $e) {
        if (strpos($e->getMessage(), 'Duplicate column name') !== false) {
            echo "‚ÑπÔ∏è  –ö–æ–ª–æ–Ω–∫–∞ 'team_id' —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ —Ç–∞–±–ª–∏—Ü–µ 'tasks'\n";
        } else {
            echo "‚ö†Ô∏è  –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–æ–ª–æ–Ω–∫–∏: " . $e->getMessage() . "\n";
        }
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–ª–æ–Ω–∫—É team_id –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Ç–∞–±–ª–∏—Ü–µ projects, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
    try {
        $mysqlDb->exec("ALTER TABLE projects ADD COLUMN team_id VARCHAR(36) NULL");
        $mysqlDb->exec("ALTER TABLE projects ADD FOREIGN KEY (team_id) REFERENCES teams(id) ON DELETE SET NULL");
        echo "‚úÖ –ö–æ–ª–æ–Ω–∫–∞ 'team_id' –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∫ —Ç–∞–±–ª–∏—Ü–µ 'projects'\n";
    } catch (Exception $e) {
        if (strpos($e->getMessage(), 'Duplicate column name') !== false) {
            echo "‚ÑπÔ∏è  –ö–æ–ª–æ–Ω–∫–∞ 'team_id' —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ —Ç–∞–±–ª–∏—Ü–µ 'projects'\n";
        } else {
            echo "‚ö†Ô∏è  –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–æ–ª–æ–Ω–∫–∏: " . $e->getMessage() . "\n";
        }
    }
    
    // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ SQLite
    echo "\nüì• –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ SQLite...\n";
    
    // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ SQLite
    $sqliteConfig = require 'config/database.php';
    $sqliteDb = new PDO(
        "sqlite:" . $sqliteConfig['database'],
        null,
        null,
        $sqliteConfig['options']
    );
    
    // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∫–æ–º–∞–Ω–¥—ã
    $teams = $sqliteDb->query("SELECT * FROM teams")->fetchAll();
    echo "üë• –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∫–æ–º–∞–Ω–¥—ã: " . count($teams) . " –∑–∞–ø–∏—Å–µ–π\n";
    foreach ($teams as $team) {
        $stmt = $mysqlDb->prepare("
            INSERT INTO teams (id, name, description, color, owner_id, created_at, updated_at) 
            VALUES (?, ?, ?, ?, ?, ?, ?)
            ON DUPLICATE KEY UPDATE 
            name = VALUES(name), 
            description = VALUES(description), 
            color = VALUES(color),
            owner_id = VALUES(owner_id),
            updated_at = VALUES(updated_at)
        ");
        $stmt->execute([
            $team['id'],
            $team['name'],
            $team['description'] ?? null,
            $team['color'] ?? '#3B82F6',
            $team['owner_id'],
            $team['created_at'],
            $team['updated_at']
        ]);
    }
    
    // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∫–æ–º–∞–Ω–¥
    $members = $sqliteDb->query("SELECT * FROM team_members")->fetchAll();
    echo "üë• –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∫–æ–º–∞–Ω–¥: " . count($members) . " –∑–∞–ø–∏—Å–µ–π\n";
    foreach ($members as $member) {
        $stmt = $mysqlDb->prepare("
            INSERT INTO team_members (id, team_id, user_id, role, joined_at) 
            VALUES (?, ?, ?, ?, ?)
            ON DUPLICATE KEY UPDATE 
            role = VALUES(role)
        ");
        $stmt->execute([
            $member['id'],
            $member['team_id'],
            $member['user_id'],
            $member['role'] ?? 'member',
            $member['joined_at']
        ]);
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∑–∞–¥–∞—á–∏ —Å team_id
    echo "üìã –û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∑–∞–¥–∞—á–∏...\n";
    $tasks = $sqliteDb->query("SELECT * FROM tasks WHERE team_id IS NOT NULL")->fetchAll();
    foreach ($tasks as $task) {
        $stmt = $mysqlDb->prepare("
            UPDATE tasks 
            SET team_id = ? 
            WHERE id = ?
        ");
        $stmt->execute([$task['team_id'], $task['id']]);
    }
    echo "‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ –∑–∞–¥–∞—á: " . count($tasks) . "\n";
    
    // –°–æ–∑–¥–∞–µ–º –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    echo "\n‚ö° –°–æ–∑–¥–∞–µ–º –∏–Ω–¥–µ–∫—Å—ã...\n";
    $indexes = [
        "CREATE INDEX IF NOT EXISTS idx_teams_owner_id ON teams (owner_id)",
        "CREATE INDEX IF NOT EXISTS idx_team_members_team_id ON team_members (team_id)",
        "CREATE INDEX IF NOT EXISTS idx_team_members_user_id ON team_members (user_id)",
        "CREATE INDEX IF NOT EXISTS idx_tasks_team_id ON tasks (team_id)",
        "CREATE INDEX IF NOT EXISTS idx_projects_team_id ON projects (team_id)",
        "CREATE INDEX IF NOT EXISTS idx_activity_logs_user_id ON activity_logs (user_id)",
        "CREATE INDEX IF NOT EXISTS idx_activity_logs_team_id ON activity_logs (team_id)"
    ];
    
    foreach ($indexes as $index) {
        try {
            $mysqlDb->exec($index);
        } catch (Exception $e) {
            // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –µ—Å–ª–∏ –∏–Ω–¥–µ–∫—Å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        }
    }
    echo "‚úÖ –ò–Ω–¥–µ–∫—Å—ã —Å–æ–∑–¥–∞–Ω—ã\n";
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    echo "\nüìä –§–ò–ù–ê–õ–¨–ù–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê –ë–ê–ó–´ –î–ê–ù–ù–´–•:\n";
    $tables = ['users', 'teams', 'team_members', 'team_invitations', 'tasks', 'projects', 'task_comments', 'activity_logs', 'notifications', 'tags', 'task_tags'];
    
    foreach ($tables as $table) {
        try {
            $count = $mysqlDb->query("SELECT COUNT(*) as count FROM $table")->fetch()['count'];
            echo "  üìã $table: $count –∑–∞–ø–∏—Å–µ–π\n";
        } catch (Exception $e) {
            echo "  ‚ùå $table: —Ç–∞–±–ª–∏—Ü–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞\n";
        }
    }
    
    echo "\nüéâ –û–ë–ù–û–í–õ–ï–ù–ò–ï –ë–ê–ó–´ –î–ê–ù–ù–´–• –ó–ê–í–ï–†–®–ï–ù–û –£–°–ü–ï–®–ù–û!\n";
    echo "üîó –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å PHPMyAdmin:\n";
    echo "   URL: http://localhost:8889/phpmyadmin\n";
    echo "   –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: serenity\n";
    echo "   –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: root\n";
    echo "   –ü–∞—Ä–æ–ª—å: root\n";
    
} catch (Exception $e) {
    echo "‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è: " . $e->getMessage() . "\n";
    echo "–°—Ç–µ–∫ –≤—ã–∑–æ–≤–æ–≤:\n" . $e->getTraceAsString() . "\n";
}

